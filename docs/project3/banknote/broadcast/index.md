---
sidebar_position: 21
---
# Алгоритм передачи банкноты

В процессе передачи банкноты участвуют две стороны:
1. **Отправитель** -- старый владелец банкноты. Может быть [банк](../03-architecture/bank/index) или [кошелёк](../../architecture/wallet/index.md)
2. **Получатель** -- новый владелец банкноты. Может быть только [кошельком](../../architecture/wallet/index.md)

Сама передача банкноты может осуществляться 
как в offline
так и в online режиме.

## Offline передача банкнот

Передача банкноты состоит из следующих шагов:
1. Взаимная аутентификация
1. Определение сдачи
1. Передача текущего множества банкнот от *отправителя* к *получателю* и сдачи (от *получателя* к *отправителю*)
1. Пропускаеться. Но присутствует в [online передаче](#online-передача-банкнот)
2. **Broadcast алгоритм** В рамках всего множества банкнот:
   1. Для каждой банкноты вызывается [receive_banknote_step1](../../functions/receive-banknote-step1.md)
   2. Все новые блоки передаются
   3. Для каждой банкноты в рамках нового блока вызывается [transfer_banknote](../../functions/transfer-banknote.md)
   4. Все новые блоки передаются обратно
   5. Вызов [receive_banknote_step2](../../functions/receive-banknote-step2.md)
   6. Новые блоки вновь передаются
1. Пропускается. Но присутствует в [online передаче](#online-передача-банкнот)
2. Пропускается. Но присутствует в [online передаче](#online-передача-банкнот)
3. *Отправитель* удаляет переданные банкноты из и сохраняет сдачу. *Получатель* сохраняет полученные банкноты, но удаляет сдачу. 


:::warning[Замечание]

Если вы работали с `ODCv2`, 
то процедура сдачи отсутствала в приципе.

Так же все банкноты передавались по одной,
теоретически это делало возможность некорректной 
процедуры транзакции, 
в рамках которой часть банкнот передавалась, а часть -- нет.

:::

Далее рассмотрим каждый из этих шагов подробнее

### Шаг 1. Взаимная аутентификация

### Шаг 2. Определение сдачи

### Шаг 3. Передача информации обо всех банкнотах.

В рамках данной операции мы не меняем владельцев банкнот.
Мы просто передаём множество банкнот от 
*отправителя* к *получателю*.

Так же, в случае сдачи -- от *получателя*
к *отправителю*.

### Шаг 5. 

Рассмотрим сначала передачу в рамках одной единственной банкноты.

...

### Шаг 6. Удаление банкнот

Если вы уже передали банкноту и она уже не ваша,
то зачем хранить информацию в кошельке?

Вы удаляете данную информацию из своего кошелька.

## Online передача банкнот

Аналогична Offline передаче, за исключением двух шагов:

1. Перед шагом 1 осуществляется 
шаг 01 для проверки всех банкнот 
2. Шаг 02 определяет кто из двух сторон будет взаимодействовать с интернет-средой.
3. Шаг 4 -- подтверждение от банка
4. Шаг 99 -- отправка подтверждения другой стороне.

### Шаг 01

### Шаг 02

